<!DOCTYPE html>
<html>
<head>
    <title>La Cueva Profunda</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: #000;
        }
        canvas {
            border: 2px solid #333;
        }
    </style>
</head>
<body>
    <canvas id="gameCanvas" width="800" height="600"></canvas>
    <script src="game.js"></script>
    <script src="level3.js"></script>
    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        
        const GAME_STATE = {
            MENU: 'menu',
            PLAYING: 'playing',
            PAUSE: 'pause',
            WIN: 'win',
            LOSE: 'lose'
        };

        const FORMS = {
            DESTRUCTOR: 'destructor',
            NINJA: 'ninja',
            MAGO: 'mago'
        };

        let state = GAME_STATE.PLAYING;
        let playerForm = FORMS.DESTRUCTOR;
        
        // Variables de nivel 3
        let level3Width = 5000;
        let crystalActivated = false;
        let lightRadius = 100;
        let leverPulled = false;
        let cartRiding = false;
        let cartX = 0;
        let cartY = 0;
        let cartSpeed = 0;
        let pathOptions = [];
        let currentPath = null;
        let nextObstacle = null;
        let batsChasing = [];

        // Elementos de la cueva
        let cuevaElements = [
            {
                type: 'crystal',
                x: 400,
                y: 300,
                w: 40,
                h: 60,
                active: false
            },
            {
                type: 'platform',
                x: 300,
                y: 400,
                w: 200,
                h: 20
            },
            {
                type: 'lever',
                x: 600,
                y: 380,
                w: 40,
                h: 60,
                pulled: false
            },
            {
                type: 'cart',
                x: 800,
                y: canvas.height - 150,
                w: 100,
                h: 80,
                locked: true
            },
            {
                type: 'track',
                x: 800,
                y: canvas.height - 100,
                w: level3Width - 800,
                h: 20
            }
        ];

        // Template para murciélagos
        const batTemplate = {
            w: 60,
            h: 40,
            speed: 3,
            frequency: 1 + Math.random(),
            amplitude: 30 + Math.random() * 20
        };

        // Jugador
        let player = {
            x: 100,
            y: canvas.height - 100,
            w: 40,
            h: 60,
            vx: 0,
            vy: 0,
            onGround: false,
            canDoubleJump: false,
            levitating: false,
            levitateTimer: 0,
            embestida: false,
            jumping: false,
            jumpStart: 0,
            jumpY: 0
        };

        // Cámara
        let cameraX = 0;

        // Control de teclas
        let keys = {};
        document.addEventListener('keydown', e => {
            keys[e.code] = true;
            if (e.code === 'Digit1') playerForm = FORMS.DESTRUCTOR;
            if (e.code === 'Digit2') playerForm = FORMS.NINJA;
            if (e.code === 'Digit3') playerForm = FORMS.MAGO;
        });
        document.addEventListener('keyup', e => keys[e.code] = false);

        // Función principal de juego
        function gameLoop() {
            updatePlayerCueva();
            drawLevel3();
            requestAnimationFrame(gameLoop);
        }

        // Función para reiniciar el nivel
        function resetLevel() {
            player.x = 100;
            player.y = canvas.height - 100;
            player.vx = 0;
            player.vy = 0;
            player.onGround = false;
            crystalActivated = false;
            lightRadius = 100;
            leverPulled = false;
            cartRiding = false;
            cartX = 0;
            cartY = 0;
            cartSpeed = 0;
            pathOptions = [];
            currentPath = null;
            nextObstacle = null;
            batsChasing = [];
            cameraX = 0;

            // Reiniciar elementos
            cuevaElements.forEach(el => {
                if (el.type === 'crystal') el.active = false;
                if (el.type === 'lever') el.pulled = false;
                if (el.type === 'cart') el.locked = true;
            });
        }

        // Función de colisión
        function collide(a, b) {
            return a.x < b.x + b.w &&
                   a.x + a.w > b.x &&
                   a.y < b.y + b.h &&
                   a.y + a.h > b.y;
        }

        // Iniciar juego
        gameLoop();
    </script>
</body>
</html>
